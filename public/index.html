<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GitHub Image Uploader (Static)</title>
    <style>
      :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
      body { margin:0; background:#0b1220; color:#e6edf3; }
      main { max-width: 980px; margin: 0 auto; padding: 24px; }
      h1 { margin: 0 0 12px; }
      .card { background:#0f1b33; border:1px solid #223357; padding:16px; border-radius:12px; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      label { display:flex; flex-direction:column; gap:6px; font-size:14px; }
      label.full { grid-column: 1 / -1; }
      input, select, button, textarea {
        padding:10px; border-radius:10px; border:1px solid #2a3f6f;
        background:#0b1220; color:#e6edf3;
      }
      button { cursor:pointer; background:#142446; }
      small { color:#9fb3c8; }
      pre { white-space: pre-wrap; word-break: break-word; margin: 0; }
      .row { display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
      .pill { padding: 2px 8px; border: 1px solid #2a3f6f; border-radius: 999px; font-size: 12px; color:#9fb3c8; }
      a { color: #8ab4ff; }
    </style>
  </head>
  <body>
    <main>
      <h1>Upload ảnh lên GitHub (Static)</h1>
      <p class="row">
        <span class="pill">PUT /repos/:owner/:repo/contents/:path</span>
        <span class="pill">Hỗ trợ folder con</span>
        <span class="pill">Overwrite / Unique name</span>
      </p>

      <div class="card">
        <form id="form" class="grid">
          <label>
            Owner (user/org)
            <input name="owner" placeholder="zknisme" required />
          </label>

          <label>
            Repo
            <input name="repo" placeholder="my-repo" required />
          </label>

          <label>
            Branch
            <input name="branch" placeholder="main" value="main" />
          </label>

          <label>
            Folder con (tuỳ chọn)
            <input name="folder" placeholder="images/2026 (không cần / đầu-cuối)" />
          </label>

          <label class="full">
            Commit message (prefix)
            <input name="message" value="Upload images via static uploader" />
          </label>

          <label class="full">
            Token (fine-grained PAT khuyến nghị)
            <input
              name="token"
              type="password"
              placeholder="github_pat_... hoặc ghp_..."
              autocomplete="off"
              required
            />
            <small>
              Token chỉ dùng trong trình duyệt. Nên tạo fine-grained PAT, giới hạn 1 repo, quyền <b>Contents: Read and write</b>, expiry ngắn.
            </small>
          </label>

          <label>
            Overwrite
            <select name="overwrite">
              <option value="false" selected>Không (an toàn)</option>
              <option value="true">Có (ghi đè nếu trùng tên)</option>
            </select>
          </label>

          <label>
            Đặt tên file
            <select name="renameMode">
              <option value="unique" selected>Unique (khỏi trùng)</option>
              <option value="keep">Giữ nguyên</option>
            </select>
          </label>

          <label class="full">
            Chọn ảnh
            <input name="files" type="file" accept="image/*" multiple required />
            <small>
              Nếu file lớn, GitHub Contents API có thể bị giới hạn kích thước → hãy nén ảnh nếu upload fail.
            </small>
          </label>

          <label class="full">
            <button type="submit">Upload</button>
          </label>
        </form>
      </div>

      <h2 style="margin:16px 0 8px;">Kết quả</h2>
      <div class="card">
        <pre id="out">(chưa có)</pre>
      </div>

      <script>
        const out = document.getElementById("out");
        const form = document.getElementById("form");

        const normalizeFolder = (folder) => {
          if (!folder) return "";
          let f = folder.trim().replace(/\\/g, "/");
          f = f.replace(/^\/+/, "").replace(/\/+$/, "");
          return f;
        };

        const sanitizeFilename = (name) => {
          const base = name.split(/[/\\]/).pop();
          return base.replace(/[^\w.\-()]/g, "-");
        };

        const encodePath = (p) => p.split("/").map(encodeURIComponent).join("/");

        const readFileAsBase64 = (file) =>
          new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onerror = () => reject(new Error("Không đọc được file."));
            fr.onload = () => {
              // data:...;base64,XXXX
              const s = String(fr.result);
              const idx = s.indexOf("base64,");
              if (idx === -1) return reject(new Error("Không lấy được base64."));
              resolve(s.slice(idx + 7));
            };
            fr.readAsDataURL(file);
          });

        async function ghFetch(url, { token, method = "GET", body } = {}) {
          const headers = {
            "Accept": "application/vnd.github+json",
            "X-GitHub-Api-Version": "2022-11-28",
            "Authorization": `Bearer ${token}`,
          };
          if (body) headers["Content-Type"] = "application/json";

          const res = await fetch(url, {
            method,
            headers,
            body: body ? JSON.stringify(body) : undefined,
          });

          const text = await res.text();
          let json = null;
          try { json = text ? JSON.parse(text) : null; } catch { json = { raw: text }; }

          if (!res.ok) {
            const msg = (json && (json.message || json.error)) || `GitHub API error ${res.status}`;
            const err = new Error(msg);
            err.status = res.status;
            err.details = json;
            throw err;
          }
          return json;
        }

        async function getShaIfExists({ token, owner, repo, branch, fullPath }) {
          const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodePath(fullPath)}?ref=${encodeURIComponent(branch)}`;
          try {
            const data = await ghFetch(url, { token, method: "GET" });
            return data && data.sha ? data.sha : null;
          } catch (e) {
            if (e.status === 404) return null;
            throw e;
          }
        }

        function uniqueName(original) {
          const safe = sanitizeFilename(original);
          const dot = safe.lastIndexOf(".");
          const ext = dot >= 0 ? safe.slice(dot) : "";
          const stem = dot >= 0 ? safe.slice(0, dot) : safe;
          const ts = new Date().toISOString().replace(/[:.]/g, "-");
          const rand = Math.random().toString(16).slice(2, 10);
          return `${stem}-${ts}-${rand}${ext}`;
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const fd = new FormData(form);
          const owner = fd.get("owner").trim();
          const repo = fd.get("repo").trim();
          const branch = (fd.get("branch") || "main").trim();
          const folder = normalizeFolder(fd.get("folder"));
          const messagePrefix = (fd.get("message") || "Upload images").trim();
          const token = (fd.get("token") || "").trim();
          const overwrite = String(fd.get("overwrite")) === "true";
          const renameMode = String(fd.get("renameMode") || "unique");

          const files = form.querySelector('input[name="files"]').files;
          if (!files || !files.length) {
            out.textContent = "Chưa chọn file.";
            return;
          }

          out.textContent = "Đang upload...\n";

          const results = [];
          for (const file of files) {
            const original = sanitizeFilename(file.name);
            const finalName = (renameMode === "unique") ? uniqueName(original) : original;
            const fullPath = folder ? `${folder}/${finalName}` : finalName;

            try {
              // base64 content
              const contentBase64 = await readFileAsBase64(file);

              // tồn tại?
              const sha = await getShaIfExists({ token, owner, repo, branch, fullPath });

              if (sha && !overwrite) {
                results.push({ ok: false, file: original, path: fullPath, error: "File đã tồn tại (bật Overwrite nếu muốn ghi đè)." });
                out.textContent += `✗ ${original} -> ${fullPath} : đã tồn tại\n`;
                continue;
              }

              const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodePath(fullPath)}`;
              const body = {
                message: `${messagePrefix}: ${original}`,
                content: contentBase64,
                branch,
                ...(sha ? { sha } : {}),
              };

              const data = await ghFetch(putUrl, { token, method: "PUT", body });

              const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${fullPath}`;
              const commitUrl = data?.commit?.html_url || null;

              results.push({ ok: true, file: original, savedAs: finalName, path: fullPath, rawUrl, commitUrl });
              out.textContent += `✓ ${original} -> ${fullPath}\n  RAW: ${rawUrl}\n`;
            } catch (err) {
              results.push({
                ok: false,
                file: original,
                path: fullPath,
                error: err.message,
                status: err.status,
                details: err.details,
              });
              out.textContent += `✗ ${original} -> ${fullPath}\n  ERROR: ${err.message}\n`;
            }
          }

          out.textContent += "\n--- JSON ---\n" + JSON.stringify({ ok: true, results }, null, 2);
        });
      </script>
    </main>
  </body>
</html>
